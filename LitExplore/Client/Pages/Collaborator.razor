@inject HttpClient Http
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager MyNavigationManager

<div class="collaborators">
    <h3 style="display: inline-block; color: var(--lavender);">Collaborators</h3>
    <button style="display:inline-block; position:absolute; right:10;"Id="addCollab" class="adder" @onclick="@(() => AddCollaborator.Show())">+</button>
    <BSTooltip Target="addCollab" Placement="Placement.Bottom">Add collaborator</BSTooltip>
    
    <BSListGroup>
        <BSListGroupItem style="display: flex; align-items:center;">
            <p style="">@project.Owner.DisplayName <b>(Owner)</b></p>
        </BSListGroupItem>
        @foreach (var user in project.Collaborators)
        {
            <BSListGroupItem style="display: flex; justify-content:space-between; align-items:center;">
                <p style="flex">@user.DisplayName</p>                
                @if(project.Owner.Id == userId){
                    <BSButton style="background-color:white; display:flex; align-items: center; justify-content:center" OnClick=@(async () => {
                        removeCollaborator(user.Id);
                        MyNavigationManager.NavigateTo($"/Project?projectId={project.Id}", true);
                        })><p style="color:black;">Remove</p>
                    </BSButton>
                }
            </BSListGroupItem>
        }
    </BSListGroup>
</div>

<BSModal @ref="AddCollaborator" Size="Size.Large">
    <BSModalHeader OnClick="@(() => {
        AddCollaborator.Hide();
        if(changeMade) MyNavigationManager.NavigateTo($"/Project?projectId={project.Id}", true);
    })">Add a collaborator to the project</BSModalHeader>
    <BSModalBody style="margin: 0 auto;">
        <BSBasicInput style="margin-top:20px; width: 20vw;" InputType="InputType.Text" @ref="UserSearchInput" Value="UserSearch" ValueChanged="@(async (string value) => { SearchedUsers = await SearchUser(value);})" ValidateOnInput="true" Placeholder="Username"/>
        @if(@SearchedUsers != null)
        {
            <ul style="width:40%; margin: 0 auto;">
            @foreach(var user in @SearchedUsers)
            {
                <li style="display: flex; justify-content:space-between;margin-top: 5px;">
                <p style="display: inline-block">@user.DisplayName</p>
                <BSButton style="display: inline-block; background-color: var(--bs-success)" @onclick="@(async ()=>{
                    AddCollaboratorToProject(user.Id);
                })">Add collaborator</BSButton>
                </li>
            }
            </ul>
        }
    </BSModalBody>
</BSModal>

@code {
    [Parameter]
    public ProjectDetailsDTO project {get; set;}
    [Parameter]
    public Guid userId {get; set;}
    private BSModal AddCollaborator;

    private bool changeMade = false;

    private BSBasicInput<string> UserSearchInput;
    private string UserSearch = string.Empty;
    private UserDTO[] SearchedUsers;

    protected async void removeCollaborator(Guid id){
        var response = await Http.PutAsJsonAsync($"api/Project/Collaborator", new ProjectAddRemoveCollaboratorDTO(project.Id, id));
    }

    protected async void AddCollaboratorToProject(Guid userId)
    {
        ProjectAddRemoveCollaboratorDTO user = new ProjectAddRemoveCollaboratorDTO(project.Id, userId);
        await Http.PostAsJsonAsync<ProjectAddRemoveCollaboratorDTO>($"api/Project/Collaborator", user);
        changeMade = true;
    }  

     protected async Task<UserDTO[]> SearchUser(string e)
    {
        UserSearch = e;
        if (UserSearch.Length > 3)
        {
            return await Http.GetFromJsonAsync<UserDTO[]>($"api/User/Name/{UserSearch}");
            changeMade = true;
        }
        return new UserDTO[0];
    }
}
